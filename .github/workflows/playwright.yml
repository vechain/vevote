name: Playwright E2E

on:
  workflow_dispatch:

  push:
    branches:
      - e2e/**

  schedule:
      # Runs at 00:00 UTC every Monday to Friday
      - cron: '0 0 * * 1-5'

env:
  CI: true

jobs:
    run-e2e-tests:
        name: E2E Tests
        runs-on: b3tr-e2e
    
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
    
          - name: Use Node v20
            uses: actions/setup-node@v3
            with:
              node-version-file: .nvmrc
              cache: "yarn"

          - name: Install dependencies
            run: yarn install --frozen-lockfile

          - name: Install browsers
            run:  |
              cd packages/e2e
              yarn install-browsers

          - name: Launch solo
            run: yarn solo-up
        
          - name: Launch app
            run:  |
              cp .env.example .env
              yarn dev:e2e &
        
          - name: Health check
            run: |
                cd packages/e2e
                chmod +x healthcheck.sh
                yarn dev:healthcheck

          - name: Run tests
            id: run-tests
            run: |
                cd packages/e2e
                yarn playwright:e2e

          - name: Upload test results
            if: always() && steps.run-tests.outcome == 'failure'
            uses: actions/upload-artifact@v4
            with:
              name: playwright-report
              path: packages/e2e/playwright-report
              retention-days: 10

          - name: Slack message
            if: always() && github.ref == 'refs/heads/master' && (steps.run-tests.outcome == 'failure')
            uses: slackapi/slack-github-action@v1.24.0
            with:
              payload: |
                {
                  "source": "E2E Tests",
                  "message": "E2E tests failed. See run ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                }
            env:
              SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

