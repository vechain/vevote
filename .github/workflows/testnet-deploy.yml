name: Testnet ‚Äî Deploy to AWS

on:
  pull_request:
    branches:
       - main
    paths: ['apps/frontend/**', 'packages/**', 'yarn.lock']

  push:
    branches:
      - main

  workflow_dispatch: # allow to deploy manually

permissions:
    contents: read
    id-token: write
    pull-requests: write

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: dev
        steps:
            - name: Checkout
              uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
              with:
                persist-credentials: false

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                node-version: 22
                cache: 'yarn'
        
            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Process Branch Name
              id: process-branch-name
              env:
                BRANCH_NAME: ${{ github.event.pull_request.head.ref || github.ref_name }}
              run: |
                  if [ "$BRANCH_NAME" != "main" ]; then
                    sanitized_branch_name=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
                    echo "processedBranchName=/$sanitized_branch_name/" >> $GITHUB_OUTPUT
                  else
                    echo "processedBranchName=/" >> $GITHUB_OUTPUT
                  fi

            - name: Build App
              env:
                  NODE_OPTIONS: '--max-old-space-size=8192'
                  MNEMONIC: ${{ secrets.MNEMONIC }}
                  TESTNET_STAGING_MNEMONIC: ${{ secrets.TESTNET_STAGING_MNEMONIC }}
                  PUBLIC_IPFS_PINNING_SERVICE: ${{ secrets.PUBLIC_IPFS_PINNING_SERVICE }}
                  VECHAIN_URL_DEVNET: ${{ secrets.VECHAIN_URL_DEVNET }}
                  VITE_BASE_PATH: ${{ steps.process-branch-name.outputs.processedBranchName }}
              run: |
                  yarn install
                  yarn build:staging

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.0.0
              env:
                AWS_REGION: eu-west-1
              with:
                  role-to-assume: ${{ secrets.AWS_ACC_ROLE }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Deploy to S3
              run: |
                  aws s3 sync ./apps/frontend/dist s3://${{ secrets.AWS_PREVIEW_BUCKET_NAME }}${{ steps.process-branch-name.outputs.processedBranchName }} --delete

            - name: Cloudfront Invalidation
              run: |
                  AWS_MAX_ATTEMPTS=10 aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_PREVIEW_CLOUDFRONT_DISTRIBUTION_ID }} --paths '/' '/*'
                  echo "üåê Deployed: https://preview.vevote-dev.vechain.org${{ steps.process-branch-name.outputs.processedBranchName }}" | tee -a "$GITHUB_STEP_SUMMARY"

            - name: Create Deployment Comment
              if: github.event.action == 'opened' || github.event.action == 'reopened' || github.event.pull_request.draft == true
              uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
              with:
                  issue-number: ${{ github.event.pull_request.number }}
                  body: |
                      # üöÄ Preview environment deployed!
                      Preview URL: https://preview.vevote-dev.vechain.org${{ steps.process-branch-name.outputs.processedBranchName }}
                  edit-mode: replace
