name: Testnet ‚Äî Deploy to AWS

on:
  pull_request:
    branches:
      - main
    paths: ['apps/frontend/**', 'packages/**', 'yarn.lock']
    types: [opened, reopened, synchronize]

  push:
    branches:
      - main

  workflow_dispatch: # allow to deploy manually

permissions: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Process Branch Name
        id: process-branch-name
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref || github.ref_name }}
        run: |
          if [ "$BRANCH_NAME" != "main" ]; then
            sanitized_branch_name=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
            echo "processedBranchName=/$sanitized_branch_name/" >> $GITHUB_OUTPUT
          else
            echo "processedBranchName=/" >> $GITHUB_OUTPUT
          fi

      - name: Build App
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'
          MNEMONIC: ${{ secrets.MNEMONIC }}
          TESTNET_STAGING_MNEMONIC: ${{ secrets.TESTNET_STAGING_MNEMONIC }}
          PUBLIC_IPFS_PINNING_SERVICE: ${{ secrets.PUBLIC_IPFS_PINNING_SERVICE }}
          VECHAIN_URL_DEVNET: ${{ secrets.VECHAIN_URL_DEVNET }}
          VITE_BASE_PATH: ${{ steps.process-branch-name.outputs.processedBranchName }}
        run: |
          yarn build:staging

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.0.0
        env:
          AWS_REGION: eu-west-1
        with:
          role-to-assume: ${{ secrets.AWS_ACC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to S3 and copy Terms and Privacy Policy files to Website # if main branch, deploy to the root path
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref || github.ref_name }}
          PROCESSED_BRANCH_NAME: ${{ steps.process-branch-name.outputs.processedBranchName }}
        run: |
          if [ "$BRANCH_NAME" != "main" ]; then
            aws s3 sync ./apps/frontend/dist s3://${{ secrets.AWS_PREVIEW_BUCKET_NAME }}${PROCESSED_BRANCH_NAME} --delete
            aws s3 cp s3://${{ secrets.AWS_POLICY_DOCS_BUCKET }} s3://${{ secrets.AWS_PREVIEW_BUCKET_NAME }}${PROCESSED_BRANCH_NAME} --recursive
          else
            aws s3 sync ./apps/frontend/dist s3://${{ secrets.AWS_BUCKET_NAME }}/
            aws s3 cp s3://${{ secrets.AWS_POLICY_DOCS_BUCKET }} s3://${{ secrets.AWS_BUCKET_NAME }}/ --recursive
          fi

      - name: Cloudfront Invalidation # if main branch, invalidate the root path
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref || github.ref_name }}
          PROCESSED_BRANCH_NAME: ${{ steps.process-branch-name.outputs.processedBranchName }}
        run: |
          if [ "$BRANCH_NAME" != "main" ]; then
            AWS_MAX_ATTEMPTS=10 aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_PREVIEW_CLOUDFRONT_DISTRIBUTION_ID }} --paths ${PROCESSED_BRANCH_NAME} '/*'
            echo "üåê Deployed: https://preview.vevote-dev.vechain.org${PROCESSED_BRANCH_NAME}" | tee -a "$GITHUB_STEP_SUMMARY"
          else
            AWS_MAX_ATTEMPTS=10 aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION_ID }} --paths '/' '/*'
            echo "üåê Deployed: https://vevote-dev.vechain.org/" | tee -a "$GITHUB_STEP_SUMMARY"
          fi

      - name: Find Comment
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4.0.0
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'üöÄ Preview environment deployed!'

      - name: Create Deployment Comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          body: |
            # üöÄ Preview environment deployed!
            Preview URL: https://preview.vevote-dev.vechain.org${{ steps.process-branch-name.outputs.processedBranchName }}
          edit-mode: replace
